<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game API & WebSocket Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Game API & WebSocket Test Interface</h1>

    <!-- Authentication Section -->
    <div class="section">
        <h2>Authentication</h2>
        <input type="email" id="email" placeholder="Email" value="test@test.com">
        <input type="password" id="password" placeholder="Password" value="test123">
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
        <button onclick="checkAuth()">Check Auth Status</button>
        <div id="auth-log" class="log"></div>
    </div>

    <!-- Queue Management -->
    <div class="section">
        <h2>Queue Management</h2>
        <button onclick="joinQueue()">Join Queue</button>
        <button onclick="leaveQueue()">Leave Queue</button>
        <div id="queue-log" class="log"></div>
    </div>

    <!-- Game Management -->
    <div class="section">
        <h2>Game Management</h2>
        <button onclick="createGame()">Create New Game</button>
        <button onclick="getActiveGames()">Get Active Games</button>
        <button onclick="getGameHistory()">Get Game History</button>
        <input type="number" id="gameId" placeholder="Game ID">
        <button onclick="getGameInfo()">Get Game Info</button>
        <div id="game-log" class="log"></div>
    </div>

    <!-- WebSocket Connection -->
    <div class="section">
        <h2>WebSocket Connection</h2>
        <input type="number" id="wsGameId" placeholder="Game ID for WebSocket">
        <button onclick="connectWebSocket()">Connect WebSocket</button>
        <button onclick="disconnectWebSocket()">Disconnect</button>
        <button onclick="sendReady()">Send Ready</button>
        <button onclick="sendMove()">Send Move</button>
        <div id="ws-log" class="log"></div>
    </div>

    <script>
        let ws = null;
        const API_BASE_URL = 'http://localhost:8000';

        // Create axios instance with base config
        const api = axios.create({
            baseURL: API_BASE_URL,
            withCredentials: true,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            xsrfCookieName: 'csrftoken',
            xsrfHeaderName: 'X-CSRFToken'
        });

        // Utility function to dump cookies
        function dumpCookies() {
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                acc[key] = value;
                return acc;
            }, {});
            return JSON.stringify(cookies, null, 2);
        }

        // Authentication functions
        async function login() {
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                logAuth('Attempting login with email: ' + email, 'info');
                
                const response = await api.post('/api/login/', 
                    { email, password },
                    {
                        withCredentials: true,
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Origin': window.location.origin
                        }
                    }
                );

                // Log all response headers in detail
                const allHeaders = response.headers;
                logAuth('All response headers:', 'info');
                for (const [key, value] of Object.entries(allHeaders)) {
                    logAuth(`${key}: ${value}`, 'info');
                }

                // Log the raw Set-Cookie header if present
                const setCookieHeader = response.headers['set-cookie'];
                if (setCookieHeader) {
                    logAuth('Set-Cookie header: ' + JSON.stringify(setCookieHeader), 'info');
                } else {
                    logAuth('No Set-Cookie header found', 'warning');
                }

                logAuth('Login response: ' + JSON.stringify(response.data, null, 2), 'success');
                logAuth('Current cookies: ' + document.cookie, 'info');
                
                // Check CORS settings
                logAuth('CORS settings check:', 'info');
                logAuth('Origin: ' + window.location.origin, 'info');
                
                setTimeout(async () => {
                    logAuth('Cookies after delay: ' + document.cookie, 'info');
                    await checkAuth();
                }, 100);

            } catch (error) {
                logAuth('Login error: ' + (error.response?.data?.error || error.message), 'error');
                if (error.response) {
                    logAuth('Error status: ' + error.response.status, 'error');
                    logAuth('Error headers: ' + JSON.stringify(error.response.headers, null, 2), 'error');
                    logAuth('Error data: ' + JSON.stringify(error.response.data, null, 2), 'error');
                }
            }
        }

        async function checkAuth() {
            try {
                logAuth('Checking auth status...', 'info');
                const cookies = dumpCookies();
                logAuth('Current cookies: ' + cookies, 'info');
                
                const response = await api.get('/api/user/', {
                    withCredentials: true,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                logAuth('Auth check successful. User data: ' + JSON.stringify(response.data, null, 2), 'success');
            } catch (error) {
                logAuth('Auth check failed: ' + (error.response?.data?.error || error.message), 'error');
                if (error.response?.status === 401) {
                    logAuth('Not authenticated. Please log in.', 'error');
                }
            }
        }

        async function logout() {
            try {
                const response = await api.post('/api/logout/');
                logAuth('Logout successful: ' + JSON.stringify(response.data, null, 2), 'success');
                logAuth('Cookies after logout: ' + dumpCookies(), 'info');
            } catch (error) {
                logAuth('Logout failed: ' + (error.response?.data?.error || error.message), 'error');
            }
        }

        // Queue functions
        async function joinQueue() {
            try {
                logQueue('Current cookies before join: ' + dumpCookies(), 'info');
                const response = await api.post('/game/join/');
                logQueue('Joined queue: ' + JSON.stringify(response.data, null, 2), 'success');
            } catch (error) {
                logQueue('Failed to join queue: ' + (error.response?.data?.error || error.message), 'error');
                if (error.response?.status === 401) {
                    logQueue('Authentication required. Please log in again.', 'error');
                }
            }
        }

        async function leaveQueue() {
            try {
                const response = await api.post('/game/leave/');
                logQueue('Left queue: ' + JSON.stringify(response.data, null, 2), 'success');
            } catch (error) {
                logQueue('Failed to leave queue: ' + (error.response?.data?.error || error.message), 'error');
            }
        }

        // Game functions
        async function createGame() {
            try {
                const response = await api.post('/game/create/');
                logGame('Game created successfully:', 'success');
                logGame(JSON.stringify(response.data, null, 2));
                
                // If game creation was successful, automatically fill the WebSocket game ID
                if (response.data.game_id) {
                    document.getElementById('wsGameId').value = response.data.game_id;
                    logGame('WebSocket game ID field has been automatically filled', 'info');
                }
            } catch (error) {
                if (error.response?.status === 401) {
                    logGame('Authentication required. Please log in first.', 'error');
                } else {
                    logGame('Failed to create game: ' + (error.response?.data?.error || error.message), 'error');
                }
            }
        }
        async function getActiveGames() {
            try {
                const response = await api.get('/game/active_games/');
                logGame('Active games:', 'success');
                logGame(JSON.stringify(response.data, null, 2));
            } catch (error) {
                logGame('Failed to get active games: ' + (error.response?.data?.error || error.message), 'error');
            }
        }

        async function getGameHistory() {
            try {
                const response = await api.get('/game/game_history/');
                logGame('Game history:', 'success');
                logGame(JSON.stringify(response.data, null, 2));
            } catch (error) {
                logGame('Failed to get game history: ' + (error.response?.data?.error || error.message), 'error');
            }
        }

        async function getGameInfo() {
            const gameId = document.getElementById('gameId').value;
            if (!gameId) {
                logGame('Please enter a game ID', 'error');
                return;
            }
            try {
                const response = await api.get(`/game/game_info/${gameId}/`);
                logGame('Game info:', 'success');
                logGame(JSON.stringify(response.data, null, 2));
            } catch (error) {
                logGame('Failed to get game info: ' + (error.response?.data?.error || error.message), 'error');
            }
        }

        // WebSocket functions
        function connectWebSocket() {
            const gameId = document.getElementById('wsGameId').value;
            if (!gameId) {
                logWS('Game ID is required', 'error');
                return;
            }

            logWS('Current cookies for WS: ' + dumpCookies(), 'info');
            const accessToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('access_token='))
                ?.split('=')[1];

            if (!accessToken) {
                logWS('No access token found. Please log in first.', 'error');
                return;
            }

            ws = new WebSocket(`ws://localhost:8000/ws/game/${gameId}/?token=${accessToken}`);

            ws.onopen = () => {
                logWS('WebSocket connected', 'success');
            };

            ws.onmessage = (event) => {
                logWS('Received: ' + event.data);
            };

            ws.onerror = (error) => {
                logWS('WebSocket error: ' + error.message, 'error');
            };

            ws.onclose = () => {
                logWS('WebSocket disconnected');
                ws = null;
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                logWS('WebSocket disconnected', 'success');
            }
        }

        function sendReady() {
            if (!ws) {
                logWS('WebSocket not connected', 'error');
                return;
            }
            ws.send(JSON.stringify({ type: 'player_ready' }));
            logWS('Sent ready signal');
        }

        function sendMove() {
            if (!ws) {
                logWS('WebSocket not connected', 'error');
                return;
            }
            ws.send(JSON.stringify({
                type: 'player_move',
                movement: {
                    x: Math.random() * 100,
                    y: Math.random() * 100
                }
            }));
            logWS('Sent move signal');
        }

        // Logging functions
        function logAuth(message, type = '') {
            const log = document.getElementById('auth-log');
            log.innerHTML = `${new Date().toLocaleTimeString()} - ${message}\n${log.innerHTML}`;
        }

        function logQueue(message, type = '') {
            const log = document.getElementById('queue-log');
            log.innerHTML = `${new Date().toLocaleTimeString()} - ${message}\n${log.innerHTML}`;
        }

        function logGame(message, type = '') {
            const log = document.getElementById('game-log');
            log.innerHTML = `${new Date().toLocaleTimeString()} - ${message}\n${log.innerHTML}`;
        }

        function logWS(message, type = '') {
            const log = document.getElementById('ws-log');
            log.innerHTML = `${new Date().toLocaleTimeString()} - ${message}\n${log.innerHTML}`;
        }
    </script>
</body>
</html>